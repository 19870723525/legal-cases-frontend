<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡ˆä¾‹æ£€ç´¢ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .filter-section {
            background-color: #b9efb3;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(90, 89, 89, 0.1);
        }
        .case-link {
            color: #7d7bf4;
            text-decoration: none;
            font-weight: 500;
        }
        .case-link:hover {
            text-decoration: underline;
            color: #2a5594;
        }
        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .table th {
            background-color: #021e3b;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .loading {
            display: none;
            padding: 20px;
            text-align: center;
        }
        .alert {
            border-radius: 8px;
        }
        .btn {
            border-radius: 6px;
            padding: 8px 16px;
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="mb-4 text-primary">æ¶‰å¤–æ³•æ¡ˆæ£€ç´¢ç³»ç»Ÿ</h1>
        
        <!-- é”™è¯¯æç¤º -->
        {% if errors %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <ul class="mb-0">
                {% for error in errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        
        <!-- ç­›é€‰è¡¨å• -->
        <div class="filter-section">
            <form method="get" action="/" id="searchForm">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">æ¡ˆå·</label>
                        <input type="text" class="form-control" name="anhao" value="{{ anhao or '' }}" 
                               placeholder="è¾“å…¥æ¡ˆå·å…³é”®è¯">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">å®¡ç†æ³•é™¢</label>
                        <input type="text" class="form-control" name="fayuan" value="{{ fayuan or '' }}" 
                               placeholder="è¾“å…¥æ³•é™¢åç§°">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">æ¡ˆä»¶ç±»å‹</label>
                        <select class="form-select" name="case_type">
                            <option value="">å…¨éƒ¨ç±»å‹</option>
                            {% if filter_options.case_types %}
                                {% for option in filter_options.case_types %}
                                <option value="{{ option }}" {% if case_type == option %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">è£åˆ¤æ—¥æœŸï¼ˆèµ·ï¼‰</label>
                        <input type="date" class="form-control" name="date_start" value="{{ date_start or '' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">è£åˆ¤æ—¥æœŸï¼ˆæ­¢ï¼‰</label>
                        <input type="date" class="form-control" name="date_end" value="{{ date_end or '' }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">ç”³è¯·ç»“æœ</label>
                        <select class="form-select" name="result_type">
                            <option value="">å…¨éƒ¨ç»“æœ</option>
                            {% if filter_options.result_types %}
                                {% for option in filter_options.result_types %}
                                <option value="{{ option }}" {% if result_type == option %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">åˆ¤å†³æ¥æºå›½</label>
                        <select class="form-select" name="country">
                            <option value="">å…¨éƒ¨å›½å®¶</option>
                            {% if filter_options.countries %}
                                {% for option in filter_options.countries %}
                                <option value="{{ option }}" {% if country == option %}selected{% endif %}>
                                    {{ option }}
                                </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col">
                        <button type="submit" class="btn btn-primary" id="searchBtn">
                            <span class="me-2"></span>æ£€ç´¢
                        </button>
                        <a href="/" class="btn btn-secondary">é‡ç½®</a>
                        {% if rows %}
                        <a href="{{ url_for('export_cases', anhao=anhao, fayuan=fayuan, date_start=date_start, date_end=date_end, case_type=case_type, result_type=result_type, country=country) }}" 
                           class="btn btn-success">
                            <span class="me-2"></span>å¯¼å‡ºCSV
                        </a>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
        
        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div class="loading alert alert-info" id="loadingIndicator">
            <div class="d-flex align-items-center">
                <div class="spinner-border me-3" role="status"></div>
                <div>æ­£åœ¨æœç´¢ï¼Œè¯·ç¨å€™...</div>
            </div>
        </div>
        
        <hr>
        
        <!-- æœç´¢ç»“æœ -->
        <div class="mt-4">
            <h3 class="mb-3">æ£€ç´¢ç»“æœ</h3>
            
            {% if rows %}
            <div class="alert alert-success">
                å…±æ‰¾åˆ°æ•°æ®ï¼Œæ˜¾ç¤ºç¬¬ 
                <strong>{{ (page-1)*PAGE_SIZE + 1 }}-{{ (page-1)*PAGE_SIZE + rows|length }}</strong> æ¡
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover table-bordered">
                    <thead>
                        <tr>
                            {% for column in display_columns %}
                            <th>{{ column }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in rows %}
                        <tr>
                            {% for column in display_columns %}
                            <td>
                                {% if column == 'æ¡ˆå·' and row.get('_generated_id') %}
                                <a href="{{ url_for('case_detail', case_id=row._generated_id, 
                                    anhao=anhao, fayuan=fayuan, date_start=date_start, 
                                    date_end=date_end, case_type=case_type, 
                                    result_type=result_type, country=country, page=page) }}" 
                                   class="case-link">
                                    {{ row[column] or '' }}
                                </a>
                                {% else %}
                                {{ row[column] or '' }}
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é¡µ -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div>
                    {% if page > 1 %}
                    <a href="?page={{ page-1 }}&anhao={{ anhao or '' }}&fayuan={{ fayuan or '' }}&date_start={{ date_start or '' }}&date_end={{ date_end or '' }}&case_type={{ case_type or '' }}&result_type={{ result_type or '' }}&country={{ country or '' }}" 
                       class="btn btn-outline-primary">
                        â† ä¸Šä¸€é¡µ
                    </a>
                    {% endif %}
                </div>
                
                <div class="text-muted">
                    ç¬¬ {{ page }} é¡µ
                </div>
                
                <div>
                    {% if has_next_page %}
                    <a href="?page={{ page+1 }}&anhao={{ anhao or '' }}&fayuan={{ fayuan or '' }}&date_start={{ date_start or '' }}&date_end={{ date_end or '' }}&case_type={{ case_type or '' }}&result_type={{ result_type or '' }}&country={{ country or '' }}" 
                       class="btn btn-outline-primary">
                        ä¸‹ä¸€é¡µ â†’
                    </a>
                    {% endif %}
                </div>
            </div>
            
            {% else %}
            <div class="alert alert-warning text-center py-5">
                <h4 class="mb-3">æ— æ£€ç´¢ç»“æœ</h4>
                <p class="mb-0">è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        // è¡¨å•æäº¤æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('searchForm').addEventListener('submit', function() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('searchBtn').innerHTML = '<span class="me-2">â³</span>æœç´¢ä¸­...';
        });
        
        // é¡µé¢åŠ è½½å®Œæˆåéšè—åŠ è½½çŠ¶æ€
        window.addEventListener('load', function() {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('searchBtn').innerHTML = '<span class="me-2">ğŸ”</span>æ£€ç´¢';
        });
    </script>
</body>
</html>